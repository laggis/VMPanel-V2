{% extends "layout.html" %}

{% block content %}
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 rounded">
  <div class="container-fluid">
    <a class="navbar-brand" href="#"><i class="fas fa-server"></i> Control Panel</a>
    <div class="collapse navbar-collapse" id="navbarColor01">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
            <a class="nav-link" href="/dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" href="/admin"><i class="fas fa-cogs"></i> Admin Panel</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" onclick="toggleTheme()" title="Toggle Theme">
                <i id="theme-icon" class="fas fa-sun"></i>
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-cogs"></i> Admin Panel</h2>
</div>

<!-- System Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card mb-3 h-100 border-primary">
            <div class="card-header text-primary"><i class="fas fa-microchip"></i> CPU Usage</div>
            <div class="card-body">
                <h3 class="card-title" id="cpuVal">--%</h3>
                <div class="progress">
                    <div id="cpuBar" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card mb-3 h-100 border-success">
            <div class="card-header text-success"><i class="fas fa-memory"></i> RAM Usage</div>
            <div class="card-body">
                <h3 class="card-title" id="ramVal">--%</h3>
                <p class="card-text small mb-1 text-muted" id="ramText">-- / -- GB</p>
                <div class="progress">
                    <div id="ramBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card mb-3 h-100 border-info">
            <div class="card-header text-info"><i class="fas fa-hdd"></i> Disk Usage</div>
            <div class="card-body">
                <h3 class="card-title" id="diskVal">--%</h3>
                <p class="card-text small mb-1 text-muted" id="diskText">-- / -- GB</p>
                <div class="progress">
                    <div id="diskBar" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card mb-3 h-100 border-secondary">
            <div class="card-header text-secondary"><i class="fas fa-network-wired"></i> Network</div>
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <span class="text-info"><i class="fas fa-arrow-down"></i> <span id="netIn">-- KB/s</span></span>
                    <span class="text-warning"><i class="fas fa-arrow-up"></i> <span id="netOut">-- KB/s</span></span>
                </div>
                <hr class="my-2">
                <small class="d-block text-muted">Total Recv: <span id="totalRecv">--</span></small>
                <small class="d-block text-muted">Total Sent: <span id="totalSent">--</span></small>
            </div>
        </div>
    </div>
</div>

<ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
        <i class="fas fa-users"></i> User Management
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="vms-tab" data-bs-toggle="tab" data-bs-target="#vms" type="button" role="tab">
        <i class="fas fa-server"></i> VPS Management
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab">
        <i class="fas fa-history"></i> Audit Logs
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="network-tab" data-bs-toggle="tab" data-bs-target="#network" type="button" role="tab">
        <i class="fas fa-network-wired"></i> Network
    </button>
  </li>
</ul>

<div class="tab-content" id="adminTabsContent">
  <!-- Users Tab -->
  <div class="tab-pane fade show active" id="users" role="tabpanel">
    <div class="card border-primary mb-4">
        <div class="card-header">Create New User</div>
        <div class="card-body">
            <form id="createUserForm" class="row g-3">
                <div class="col-md-3">
                    <input type="text" id="newUsername" placeholder="Username" class="form-control" required>
                </div>
                <div class="col-md-3">
                    <input type="password" id="newPassword" placeholder="Password" class="form-control" required>
                </div>
                <div class="col-md-2">
                    <select id="newRole" class="form-select">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="text" id="newWebhook" placeholder="Discord Webhook URL (Optional)" class="form-control">
                </div>
                <div class="col-md-12">
                    <button type="submit" class="btn btn-primary w-100">Create User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit User</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" id="editUsername" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="editPassword" class="form-control" placeholder="Leave blank to keep current">
                </div>
                <div class="mb-3">
                    <label class="form-label">Role</label>
                    <select id="editRole" class="form-select">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Discord Webhook URL</label>
                    <input type="text" id="editWebhook" class="form-control" placeholder="https://discord.com/api/webhooks/...">
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                <!-- Populated by JS -->
            </tbody>
        </table>
    </div>
  </div>

  <!-- VMs Tab -->
  <div class="tab-pane fade" id="vms" role="tabpanel">
    
    <!-- Toolbar -->
    <div class="d-flex justify-content-between mb-3">
        <div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#provisionVMModal">
                <i class="fas fa-box-open"></i> Provision New VPS
            </button>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addVMModal">
                <i class="fas fa-plus"></i> Register New VPS
            </button>
            <button class="btn btn-outline-secondary" onclick="loadVMs()">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>
        <div>
            <input type="text" id="vmSearch" class="form-control" placeholder="Search VMs..." onkeyup="filterVMs()">
        </div>
    </div>

    <!-- Modal for Adding VM -->
    <div class="modal fade" id="addVMModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Register New VPS</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="createVMForm">
                <div class="mb-3">
                    <label class="form-label">VM Name</label>
                    <input type="text" id="vmName" placeholder="My Virtual Machine" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">VMX Path</label>
                    <div class="input-group">
                        <input type="text" id="vmPath" list="vmPathList" placeholder="C:\Path\To\file.vmx" class="form-control" required>
                        <button class="btn btn-secondary" type="button" onclick="scanVMs()" title="Scan for .vmx files">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <datalist id="vmPathList"></datalist>
                    <small class="text-muted">Click the search icon to scan common directories.</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Assign Owner</label>
                    <select id="vmOwner" class="form-select">
                        <option value="">-- No Owner --</option>
                        <!-- Populated by JS -->
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Expiration Date</label>
                    <input type="date" id="vmExpiration" class="form-control">
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">Register VM</button>
                </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for Provisioning VM -->
    <div class="modal fade" id="provisionVMModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Provision New VPS (From Template)</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="provisionVMForm">
                <div class="mb-3">
                    <label class="form-label">VM Name</label>
                    <input type="text" id="provVmName" placeholder="Customer-VPS-01" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Assign Owner</label>
                    <select id="provVmOwner" class="form-select" required>
                        <!-- Populated by JS -->
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Clone Type</label>
                    <select id="provCloneType" class="form-select">
                        <option value="linked">Linked Clone (Fast, Saves Space)</option>
                        <option value="full">Full Clone (Independent, Slower)</option>
                    </select>
                    <small class="text-muted">Linked requires the Template to stay online. Full copies everything.</small>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">CPU Cores</label>
                        <input type="number" id="provCpuCores" class="form-control" value="2" min="1" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">RAM (MB)</label>
                        <input type="number" id="provRamMb" class="form-control" value="4096" min="1024" step="1024" required>
                    </div>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> New VM will be created in <code>C:\Virtual Machines\Customers</code>
                </div>
                <button type="submit" class="btn btn-primary w-100">Provision VM</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for Editing VM -->
    <div class="modal fade" id="editVMModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit VPS</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="editVMForm">
                <input type="hidden" id="editVMId">
                <div class="mb-3">
                    <label class="form-label">VM Name</label>
                    <input type="text" id="editVMName" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">VMX Path</label>
                    <input type="text" id="editVMPath" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Assign Owner</label>
                    <select id="editVMOwner" class="form-select">
                        <option value="">-- No Owner --</option>
                        <!-- Populated by JS -->
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Internal IP (Static)</label>
                    <input type="text" id="editVMInternalIP" class="form-control" placeholder="192.168.119.x">
                    <small class="text-muted">Stored IP for reference. Use "Network Config" to apply changes to Guest.</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Expiration Date</label>
                    <input type="date" id="editVMExpiration" class="form-control">
                </div>
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-warning" onclick="updateServiceAccount()">
                        <i class="fas fa-tools"></i> Update Service Account (Fix Registry)
                    </button>
                </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Network Config Modal -->
    <div class="modal fade" id="netConfigModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Network Configuration</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="netConfigForm">
                <input type="hidden" id="netConfigVmId">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Settings are applied to Host DHCP. If VM is running, a <b>Reboot</b> may be required to take effect.
                </div>
                <div class="mb-3">
                    <label class="form-label">Static IP Address</label>
                    <input type="text" id="netStaticIP" class="form-control" placeholder="192.168.119.x" required>
                    <small class="text-muted">Ensure this IP matches your Port Forwarding rules.</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Gateway</label>
                    <input type="text" id="netGateway" class="form-control" placeholder="192.168.119.2" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">DNS Servers (Comma separated)</label>
                    <input type="text" id="netDNS" class="form-control" value="8.8.8.8, 8.8.4.4">
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">Apply Static IP</button>
                </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Path</th>
                    <th>Owner</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="vmTableBody">
                <!-- Populated by JS -->
            </tbody>
        </table>
    </div>
  </div>

  <!-- Logs Tab -->
  <div class="tab-pane fade" id="logs" role="tabpanel">
    <div class="table-responsive">
        <table class="table table-hover table-striped">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>User ID</th>
                    <th>Action</th>
                    <th>Target VM</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody id="logsTableBody">
                <!-- Populated by JS -->
            </tbody>
        </table>
    </div>
  </div>

  <!-- Network Tab -->
  <div class="tab-pane fade" id="network" role="tabpanel">
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card border-info">
                <div class="card-header">Add Port Forwarding Rule</div>
                <div class="card-body">
                    <form id="addNetworkRuleForm" class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label class="form-label">VM (Optional)</label>
                            <select id="ruleVmId" class="form-select">
                                <option value="">-- Select VM --</option>
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Protocol</label>
                            <select id="ruleProtocol" class="form-select">
                                <option value="tcp">TCP</option>
                                <option value="udp">UDP</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Host Port</label>
                            <input type="number" id="ruleHostPort" class="form-control" placeholder="8080" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Guest IP</label>
                            <input type="text" id="ruleGuestIP" class="form-control" placeholder="192.168.119.128" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Guest Port</label>
                            <input type="number" id="ruleGuestPort" class="form-control" placeholder="80" required>
                        </div>
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-primary w-100">Add Rule</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <h5>TCP Rules</h5>
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead>
                        <tr>
                            <th>Host Port</th>
                            <th>Target</th>
                            <th>VM Name</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="tcpRulesBody"></tbody>
                </table>
            </div>
        </div>
        <div class="col-md-6">
            <h5>UDP Rules</h5>
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead>
                        <tr>
                            <th>Host Port</th>
                            <th>Target</th>
                            <th>VM Name</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="udpRulesBody"></tbody>
                </table>
            </div>
        </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let users = [];

    async function loadUsers() {
        try {
            const res = await api.get('/admin/users');
            users = res.data;
            renderUsers();
            updateOwnerDropdown();
        } catch(err) { console.error("Failed to load users", err); }
    }
    
    function renderUsers() {
        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = users.map(u => `
            <tr>
                <td>${u.id}</td>
                <td>${u.username}</td>
                <td><span class="badge bg-${u.role === 'admin' ? 'danger' : 'info'}">${u.role}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-warning" onclick="openEditUserModal(${u.id})"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${u.id})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');
    }

    async function deleteUser(id) {
        if (!confirm('Are you sure you want to delete this user?')) return;
        try {
            await api.delete(`/admin/users/${id}`);
            loadUsers();
        } catch(err) {
            alert('Failed to delete user: ' + (err.response?.data?.detail || err.message));
        }
    }

    function openEditUserModal(userId) {
        const user = users.find(u => u.id === userId);
        if (!user) return;

        document.getElementById('editUserId').value = user.id;
        document.getElementById('editUsername').value = user.username;
        document.getElementById('editRole').value = user.role;
        document.getElementById('editWebhook').value = user.discord_webhook_url || '';
        document.getElementById('editPassword').value = ''; // Clear password field

        const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
        modal.show();
    }

    document.getElementById('editUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const userId = document.getElementById('editUserId').value;
        const payload = {
            username: document.getElementById('editUsername').value,
            role: document.getElementById('editRole').value,
            discord_webhook_url: document.getElementById('editWebhook').value || null
        };
        const password = document.getElementById('editPassword').value;
        if (password) {
            payload.password = password;
        }

        try {
            await api.put(`/admin/users/${userId}`, payload);
            const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
            modal.hide();
            loadUsers();
            alert('User updated successfully!');
        } catch(err) {
            alert('Failed to update user: ' + (err.response?.data?.detail || err.message));
        }
    });

    function updateOwnerDropdown() {
        const select = document.getElementById('vmOwner');
        const editSelect = document.getElementById('editVMOwner');
        const provSelect = document.getElementById('provVmOwner');
        const currentVal = select.value;
        const currentEditVal = editSelect.value;
        
        const options = '<option value="">-- No Owner --</option>' + 
            users.map(u => `<option value="${u.id}">${u.username} (ID: ${u.id})</option>`).join('');
            
        select.innerHTML = options;
        editSelect.innerHTML = options;
        if(provSelect) provSelect.innerHTML = options;
        
        if (currentVal) select.value = currentVal;
        if (currentEditVal) editSelect.value = currentEditVal;
    }

    function updateNetworkVmDropdown() {
        const select = document.getElementById('ruleVmId');
        if (!select) return;
        const currentVal = select.value;
        select.innerHTML = '<option value="">-- Select VM --</option>' + 
            currentVMs.map(v => `<option value="${v.id}">${v.name} (ID: ${v.id})</option>`).join('');
        if (currentVal) select.value = currentVal;
    }

    let currentVMs = [];

    async function loadVMs() {
        try {
            const res = await api.get('/admin/vms');
            currentVMs = res.data;
            updateNetworkVmDropdown();
            const tbody = document.getElementById('vmTableBody');
            tbody.innerHTML = res.data.map(v => {
                const owner = users.find(u => u.id === v.owner_id);
                return `
                <tr>
                    <td>${v.id}</td>
                    <td><strong>${v.name}</strong></td>
                    <td><small class="text-muted text-truncate d-inline-block" style="max-width: 250px;" title="${v.vmx_path}">${v.vmx_path}</small></td>
                    <td>${owner ? `<span class="badge bg-info">${owner.username}</span>` : '<span class="badge bg-secondary">Unassigned</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" title="Network Config" onclick="openNetConfig(${v.id})"><i class="fas fa-network-wired"></i></button>
                        <button class="btn btn-sm btn-outline-primary" title="Edit" onclick="openEditVMModal(${v.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" title="Delete" onclick="deleteVM(${v.id})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `}).join('');
        } catch(err) { console.error("Failed to load VMs", err); }
    }

    function filterVMs() {
        const input = document.getElementById('vmSearch');
        const filter = input.value.toUpperCase();
        const table = document.getElementById('vmTableBody');
        const tr = table.getElementsByTagName('tr');

        for (let i = 0; i < tr.length; i++) {
            const tdName = tr[i].getElementsByTagName('td')[1];
            const tdPath = tr[i].getElementsByTagName('td')[2];
            if (tdName || tdPath) {
                const txtValueName = tdName.textContent || tdName.innerText;
                const txtValuePath = tdPath.textContent || tdPath.innerText;
                if (txtValueName.toUpperCase().indexOf(filter) > -1 || txtValuePath.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }

    async function deleteVM(id) {
        if (!confirm('Are you sure you want to remove this VM from the panel?')) return;
        try {
            await api.delete(`/admin/vms/${id}`);
            loadVMs();
        } catch(err) {
            alert('Failed to delete VM: ' + (err.response?.data?.detail || err.message));
        }
    }

    function openEditVMModal(vmId) {
        const vm = currentVMs.find(v => v.id === vmId);
        if (!vm) return;

        document.getElementById('editVMId').value = vm.id;
        document.getElementById('editVMName').value = vm.name;
        document.getElementById('editVMPath').value = vm.vmx_path;
        document.getElementById('editVMOwner').value = vm.owner_id || "";
        // Pre-fill with existing Internal IP, or fallback to current RDP IP if available (to help user lock it in)
        document.getElementById('editVMInternalIP').value = vm.internal_ip || vm.rdp_ip || "";

        const modal = new bootstrap.Modal(document.getElementById('editVMModal'));
        modal.show();
    }

    document.getElementById('editVMForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const vmId = document.getElementById('editVMId').value;
        const ownerId = document.getElementById('editVMOwner').value;
        
        const payload = {
            name: document.getElementById('editVMName').value,
            vmx_path: document.getElementById('editVMPath').value,
            owner_id: ownerId ? parseInt(ownerId) : null,
            internal_ip: document.getElementById('editVMInternalIP').value || null
        };

        try {
            await api.put(`/admin/vms/${vmId}`, payload);
            const modal = bootstrap.Modal.getInstance(document.getElementById('editVMModal'));
            modal.hide();
            loadVMs();
            alert('VM updated successfully!');
        } catch(err) {
            alert('Failed to update VM: ' + (err.response?.data?.detail || err.message));
        }
    });

    async function scanVMs() {
        const btn = document.querySelector('button[onclick="scanVMs()"]');
        const originalText = btn.innerHTML;
        
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;

        try {
            const res = await api.get('/admin/scan_vms');
            const paths = res.data.paths;
            const datalist = document.getElementById('vmPathList');
            datalist.innerHTML = paths.map(p => `<option value="${p}">`).join('');
            
            if (paths.length > 0) {
                alert(`Found ${paths.length} VMX files. They are now available in the autocomplete list.`);
            } else {
                alert('No VMX files found in common directories.');
            }
        } catch(err) {
            alert('Scan failed: ' + (err.response?.data?.detail || err.message));
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // --- Network Management ---
    async function loadNetworkRules() {
        try {
            const res = await api.get('/network/forwarding');
            renderNetworkRules(res.data);
        } catch(err) {
            console.error("Failed to load network rules", err);
        }
    }

    function renderNetworkRules(data) {
        const renderRow = (rule, protocol) => `
            <tr>
                <td><span class="badge bg-secondary">${rule.host_port}</span></td>
                <td>${rule.guest_ip}:${rule.guest_port}</td>
                <td><small>${rule.vm_name || '-'}</small></td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteNetworkRule('${protocol}', ${rule.host_port})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;

        document.getElementById('tcpRulesBody').innerHTML = data.tcp.map(r => renderRow(r, 'tcp')).join('');
        document.getElementById('udpRulesBody').innerHTML = data.udp.map(r => renderRow(r, 'udp')).join('');
    }

    document.getElementById('addNetworkRuleForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const vmId = document.getElementById('ruleVmId').value;
        const payload = {
            protocol: document.getElementById('ruleProtocol').value,
            host_port: parseInt(document.getElementById('ruleHostPort').value),
            guest_ip: document.getElementById('ruleGuestIP').value,
            guest_port: parseInt(document.getElementById('ruleGuestPort').value),
            vm_id: vmId ? parseInt(vmId) : null
        };

        try {
            await api.post('/network/forwarding', payload);
            alert('Rule added successfully! Service restarted.');
            document.getElementById('addNetworkRuleForm').reset();
            loadNetworkRules();
        } catch(err) {
            alert('Failed to add rule: ' + (err.response?.data?.detail || err.message));
        }
    });

    async function deleteNetworkRule(protocol, hostPort) {
        if (!confirm(`Are you sure you want to delete the forwarding rule for Host Port ${hostPort}?`)) return;
        try {
            await api.delete(`/network/forwarding/${protocol}/${hostPort}`);
            alert('Rule deleted successfully!');
            loadNetworkRules();
        } catch(err) {
            alert('Failed to delete rule: ' + (err.response?.data?.detail || err.message));
        }
    }

    // Load network rules when tab is clicked
    document.getElementById('network-tab').addEventListener('shown.bs.tab', function (event) {
        loadNetworkRules();
    });

    async function loadLogs() {
        try {
            const res = await api.get('/admin/audit_logs');
            const tbody = document.getElementById('logsTableBody');
            tbody.innerHTML = res.data.map(log => `
                <tr>
                    <td>${new Date(log.timestamp).toLocaleString()}</td>
                    <td>${log.user_id}</td>
                    <td><span class="badge bg-secondary">${log.action}</span></td>
                    <td>${log.vm_id || '-'}</td>
                    <td>${log.details || ''}</td>
                </tr>
            `).join('');
        } catch(err) { console.error("Failed to load logs", err); }
    }
    
    document.getElementById('createUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            await api.post('/admin/users', {
                username: document.getElementById('newUsername').value,
                password: document.getElementById('newPassword').value,
                role: document.getElementById('newRole').value,
                discord_webhook_url: document.getElementById('newWebhook').value || null
            });
            loadUsers();
            e.target.reset();
        } catch(err) { alert('Failed to create user: ' + (err.response?.data?.detail || err.message)); }
    });
    
    document.getElementById('createVMForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            const ownerId = document.getElementById('vmOwner').value;
            const expiration = document.getElementById('vmExpiration').value;
            await api.post('/admin/vms', {
                name: document.getElementById('vmName').value,
                vmx_path: document.getElementById('vmPath').value,
                owner_id: ownerId ? parseInt(ownerId) : null,
                expiration_date: expiration ? expiration : null
            });
            loadVMs();
            e.target.reset();
        } catch(err) { alert('Failed to register VM: ' + (err.response?.data?.detail || err.message)); }
    });
    
    // Initial load
    (async () => {
        await loadUsers(); // Load users first so we can map IDs to names
        await loadVMs();
        // Load logs when the tab is clicked, or just load them now if it's not too heavy
        await loadLogs(); 
        updateSystemStats();
        setInterval(updateSystemStats, 5000);
    })();

    async function updateSystemStats() {
        try {
            const res = await api.get('/admin/stats');
            const s = res.data;
            
            // CPU
            document.getElementById('cpuVal').textContent = s.cpu + '%';
            document.getElementById('cpuBar').style.width = s.cpu + '%';
            
            // RAM
            document.getElementById('ramVal').textContent = s.ram.percent + '%';
            document.getElementById('ramText').textContent = `${s.ram.used} / ${s.ram.total} GB`;
            document.getElementById('ramBar').style.width = s.ram.percent + '%';
            
            // Disk
            document.getElementById('diskVal').textContent = s.disk.percent + '%';
            document.getElementById('diskText').textContent = `${s.disk.used} / ${s.disk.total} GB`;
            document.getElementById('diskBar').style.width = s.disk.percent + '%';
            
            // Network
            if (s.net) {
                const now = Date.now();
                if (window.lastNet && window.lastTime) {
                    const timeDiff = (now - window.lastTime) / 1000; // seconds
                    if (timeDiff > 0) {
                        const recvSpeed = (s.net.recv - window.lastNet.recv) / timeDiff; // bytes/sec
                        const sentSpeed = (s.net.sent - window.lastNet.sent) / timeDiff;
                        
                        document.getElementById('netIn').textContent = formatSpeed(recvSpeed);
                        document.getElementById('netOut').textContent = formatSpeed(sentSpeed);
                    }
                }
                
                document.getElementById('totalRecv').textContent = formatBytes(s.net.recv);
                document.getElementById('totalSent').textContent = formatBytes(s.net.sent);
                
                window.lastNet = s.net;
                window.lastTime = now;
            }
            
        } catch(err) {
            console.error("Stats error", err);
        }
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatSpeed(bytesPerSec) {
        return formatBytes(bytesPerSec) + '/s';
    }

    document.getElementById('provisionVMForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('provVmName').value;
        const ownerId = document.getElementById('provVmOwner').value;
        const cloneType = document.getElementById('provCloneType').value;
        const cpuCores = parseInt(document.getElementById('provCpuCores').value);
        const ramMb = parseInt(document.getElementById('provRamMb').value);
        const btn = e.target.querySelector('button[type="submit"]');
        
        if (!ownerId) {
            alert("Please assign an owner.");
            return;
        }
        
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Provisioning...';
        
        try {
            await api.post('/admin/vms/provision', {
                name: name,
                owner_id: parseInt(ownerId),
                clone_type: cloneType,
                cpu_cores: cpuCores,
                ram_mb: ramMb
            });
            const modal = bootstrap.Modal.getInstance(document.getElementById('provisionVMModal'));
            modal.hide();
            loadVMs();
            alert('VM Provisioned Successfully!');
            e.target.reset();
        } catch(err) {
            alert('Provisioning failed: ' + (err.response?.data?.detail || err.message));
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });

    async function openNetConfig(id) {
        document.getElementById('netConfigVmId').value = id;
        
        // Auto-fill Gateway and DNS
        document.getElementById('netGateway').value = "192.168.119.2";
        document.getElementById('netDNS').value = "1.1.1.1, 1.0.0.1";
        
        const input = document.getElementById('netStaticIP');
        input.placeholder = "Loading...";
        input.value = "";
        
        // Show Modal IMMEDIATELY so user doesn't think it's broken
        const modal = new bootstrap.Modal(document.getElementById('netConfigModal'));
        modal.show();

        // Check saved Internal IP first (Persistence)
        const vm = currentVMs.find(v => v.id === id);
        if (vm && vm.internal_ip) {
            input.value = vm.internal_ip;
        }
        
        // Attempt to auto-detect current IP (as backup or verification)
        try {
            const res = await api.get(`/admin/vms/${id}/guest_ip`);
            if (res.data.ip && res.data.ip !== "Unknown (Tools not ready?)") {
                 // If we have no saved IP, use the live one
                 if (!input.value) {
                     input.value = res.data.ip;
                 } else if (input.value !== res.data.ip) {
                     // Optional: Could warn user that Live IP != Saved IP
                     console.warn(`Live IP (${res.data.ip}) differs from Saved IP (${input.value})`);
                 }
            } else {
                 if (!input.value) input.placeholder = "192.168.119.x";
            }
        } catch (e) {
            console.error("Failed to fetch IP (Normal if VM has no IP)", e);
            if (!input.value) input.placeholder = "192.168.119.x";
        }
    }

    document.getElementById('netConfigForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('netConfigVmId').value;
        const ip = document.getElementById('netStaticIP').value;
        const gateway = document.getElementById('netGateway').value;
        const dns = document.getElementById('netDNS').value.split(',').map(s => s.trim());
        const btn = e.target.querySelector('button[type="submit"]');
        
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Applying...';

        try {
            const res = await api.post(`/vms/${id}/static_ip`, {
                ip, gateway, dns
            });
            alert(res.data.message);
            bootstrap.Modal.getInstance(document.getElementById('netConfigModal')).hide();
        } catch (err) {
            alert("Failed to set IP: " + (err.response?.data?.detail || err.message));
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    });
</script>
{% endblock %}